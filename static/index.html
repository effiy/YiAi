<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YiAi API Debugger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-key { color: #d14; }
        .json-value { color: #099; }
        .json-string { color: #d14; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-[100%] mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
            <h1 class="text-2xl font-bold">YiAi API Debugger</h1>
            <div class="text-sm">v1.0.0</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 p-6">
            <!-- Left Panel: Request Configuration -->
            <div class="md:col-span-1 space-y-4 border-r pr-6">
                <div class="relative group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Load Example</label>
                    <div class="relative">
                        <input type="text" id="exampleSearch" 
                               class="w-full p-2 pr-8 border rounded text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                               placeholder="Search or select example..."
                               autocomplete="off">
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div id="exampleDropdown" class="hidden absolute z-20 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-y-auto">
                        <!-- Options injected by JS -->
                    </div>
                </div>

                <div>
                    <label for="moduleName" class="block text-sm font-medium text-gray-700 mb-1">Module Name</label>
                    <input type="text" id="moduleName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" 
                           value="services.web.crawler.crawler_service">
                </div>

                <div>
                    <label for="methodName" class="block text-sm font-medium text-gray-700 mb-1">Method Name</label>
                    <input type="text" id="methodName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" 
                           value="crawl_and_extract">
                </div>

                <div>
                    <label for="requestMethod" class="block text-sm font-medium text-gray-700 mb-1">Request Method</label>
                    <select id="requestMethod" class="w-full p-2 border rounded bg-white">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                    </select>
                </div>

                <div>
                    <label for="parameters" class="block text-sm font-medium text-gray-700 mb-1">Parameters (JSON)</label>
                    <textarea id="parameters" rows="8" class="w-full p-2 border rounded font-mono text-sm focus:ring-2 focus:ring-blue-500"
                              placeholder='{"key": "value"}'>
{
    "url": "https://www.qbitai.com/"
}</textarea>
                </div>

                <div class="flex space-x-2">
                    <button onclick="sendRequest()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                        Send Request
                    </button>
                    <button onclick="saveApiData(this)" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                        Save
                    </button>
                </div>
            </div>

            <!-- Right Panel: Response -->
            <div class="md:col-span-2 flex flex-col h-full border-r pr-6">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800">Response</h2>
                    <span id="statusBadge" class="hidden px-2 py-1 text-xs font-bold rounded"></span>
                </div>
                
                <div class="relative flex-1">
                    <div id="loading" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                    <pre id="responseBody" class="w-full h-full min-h-[500px] p-4 bg-gray-50 border rounded font-mono text-sm overflow-auto"></pre>
                </div>
            </div>

            <!-- Far Right Panel: Saved APIs -->
            <div class="md:col-span-1 flex flex-col h-full">
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Saved APIs</h3>
                    <button onclick="loadSavedApis()" class="text-xs text-blue-600 hover:text-blue-800">Refresh</button>
                </div>
                <div id="savedApisList" class="space-y-2 flex-1 overflow-y-auto min-h-[500px]">
                    <!-- Saved APIs will be loaded here -->
                    <div class="text-sm text-gray-400 text-center py-4">No saved APIs</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const examples = {
            // --- Web Crawler (Crawl4AI) ---
            crawler_links: {
                label: "Crawler: Crawl & Extract Links",
                module: "services.web.crawler.crawler_service",
                method: "crawl_and_extract",
                params: '{\n    "url": "https://www.qbitai.com/",\n    "min_title_length": 5\n}',
                reqMethod: "GET"
            },
            crawler_metadata: {
                label: "Crawler: Extract Metadata",
                module: "services.web.crawler.crawler_service",
                method: "extract_metadata",
                params: '{\n    "url": "https://www.qbitai.com/"\n}',
                reqMethod: "GET"
            },

            // --- Browser Automation (Playwright) ---
            browser_screenshot: {
                label: "Browser: Take Screenshot",
                module: "services.web.puppeteer.browser_service",
                method: "take_screenshot",
                params: '{\n    "url": "https://www.google.com",\n    "full_page": true\n}',
                reqMethod: "GET"
            },
            browser_html: {
                label: "Browser: Get HTML Content",
                module: "services.web.puppeteer.browser_service",
                method: "get_html_content",
                params: '{\n    "url": "https://www.example.com"\n}',
                reqMethod: "GET"
            },
            browser_open: {
                label: "Browser: Open Page (Headless)",
                module: "services.web.puppeteer.browser_service",
                method: "open_page",
                params: '{\n    "url": "https://www.google.com"\n}',
                reqMethod: "GET"
            },

            // --- AI Chat (Ollama) ---
            chat: {
                label: "AI: Chat (Ollama)",
                module: "services.ai.chat_service",
                method: "chat",
                params: '{\n    "user": "你好，请介绍一下你自己",\n    "system": "你是一个有用的AI助手",\n    "model": "qwen3"\n}',
                reqMethod: "GET"
            },

            // --- Database Operations ---
            db_query: {
                label: "Data: Query Documents",
                module: "services.database.data_service",
                method: "query_documents",
                params: '{\n    "cname": "users",\n    "limit": 10\n}',
                reqMethod: "GET"
            },
            db_create: {
                label: "Data: Create Document",
                module: "services.database.data_service",
                method: "create_document",
                params: '{\n    "cname": "users",\n    "name": "test_user",\n    "age": 25\n}',
                reqMethod: "POST"
            },

            // --- RSS Scheduler ---
            rss_status: {
                label: "RSS: Get Scheduler Status",
                module: "services.rss.rss_scheduler",
                method: "get_scheduler_status_info",
                params: '{}',
                reqMethod: "GET"
            },
            rss_parse: {
                label: "RSS: Parse All Sources",
                module: "services.rss.rss_scheduler",
                method: "parse_all_enabled_rss_sources",
                params: '{}',
                reqMethod: "GET"
            },

            // --- Storage ---
            file_list: {
                label: "Storage: List Files",
                module: "services.storage.file_service",
                method: "list_files",
                params: '{\n    "directory": "images/",\n    "tags": ""\n}',
                reqMethod: "GET"
            }
        };

        function initExamples() {
            const searchInput = document.getElementById('exampleSearch');
            const dropdown = document.getElementById('exampleDropdown');
            
            // Render all options initially
            renderDropdownOptions('');

            // Input handler
            searchInput.addEventListener('input', (e) => {
                const keyword = e.target.value;
                renderDropdownOptions(keyword);
                dropdown.classList.remove('hidden');
            });

            // Focus handler
            searchInput.addEventListener('focus', () => {
                dropdown.classList.remove('hidden');
            });

            // Click outside handler to close
            document.addEventListener('click', (e) => {
                const wrapper = searchInput.closest('.relative.group');
                if (!wrapper.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        function renderDropdownOptions(keyword) {
            const dropdown = document.getElementById('exampleDropdown');
            dropdown.innerHTML = '';
            
            keyword = keyword.toLowerCase();
            let hasResults = false;

            for (const [key, val] of Object.entries(examples)) {
                if (val.label.toLowerCase().includes(keyword) || key.toLowerCase().includes(keyword)) {
                    hasResults = true;
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-blue-50 cursor-pointer text-sm text-gray-700 border-b border-gray-100 last:border-0';
                    div.textContent = val.label;
                    div.onclick = () => {
                        selectExample(key, val.label);
                    };
                    dropdown.appendChild(div);
                }
            }

            if (!hasResults) {
                const div = document.createElement('div');
                div.className = 'p-2 text-sm text-gray-500 italic text-center';
                div.textContent = 'No matches found';
                dropdown.appendChild(div);
            }
        }

        function selectExample(key, label) {
            document.getElementById('exampleSearch').value = label;
            document.getElementById('exampleDropdown').classList.add('hidden');
            loadExample(key);
        }

        function loadExample(key) {
            const example = examples[key];
            if (example) {
                document.getElementById('moduleName').value = example.module;
                document.getElementById('methodName').value = example.method;
                document.getElementById('parameters').value = example.params;
                document.getElementById('requestMethod').value = example.reqMethod;
            }
        }

        // Load history and saved APIs on startup
        document.addEventListener('DOMContentLoaded', () => {
            initExamples();
            loadSavedApis();
        });

        async function loadSavedApis() {
            const listContainer = document.getElementById('savedApisList');
            selectedApiId = null;
            
            try {
                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        module_name: 'services.database.data_service',
                        method_name: 'query_documents',
                        parameters: { cname: 'apis', pageSize: 100 }
                    })
                };

                const res = await fetch('/', options);
                const data = await res.json();
                
                let items = [];
                const payload = (data && typeof data === 'object' && 'data' in data) ? data.data : data;
                if (Array.isArray(payload)) {
                    items = payload;
                } else if (payload && Array.isArray(payload.list)) {
                    items = payload.list;
                } else if (payload && Array.isArray(payload.data)) {
                    items = payload.data;
                }

                if (items.length === 0) {
                    listContainer.innerHTML = '<div class="text-sm text-gray-400 text-center py-4">No saved APIs</div>';
                    return;
                }
                
                listContainer.innerHTML = items.map((item) => {
                        // Use _id or key as identifier
                        const id = item._id || item.key;
                        const label = item.method_name || 'Unknown Method';
                        const module = item.module_name ? item.module_name.split('.').pop() : 'Unknown Module';
                        const reqMethod = item.request_method || 'GET';
                        
                        // Safe serialization for onclick attribute
                        const itemStr = JSON.stringify(item).replace(/"/g, '&quot;');
                        
                        return `
                        <div class="p-2 bg-gray-50 border rounded cursor-pointer hover:bg-blue-50 transition text-xs select-none api-item"
                             onclick="fillApiForm(this)"
                             onmousedown="handleApiItemPress(this, '${id}')"
                             ontouchstart="handleApiItemPress(this, '${id}')"
                             onmouseup="cancelApiItemPress()"
                             ontouchend="cancelApiItemPress()"
                             onmouseleave="cancelApiItemPress()"
                             data-id="${id}"
                             data-item="${itemStr}">
                            <div class="font-bold text-gray-700 truncate" title="${item.module_name}">${module}</div>
                            <div class="flex justify-between mt-1 text-gray-500">
                                <span class="truncate pr-2" title="${item.method_name}">${label}</span>
                                <span class="uppercase font-mono flex-shrink-0">${reqMethod}</span>
                            </div>
                        </div>
                        `;
                    }).join('');
            } catch (err) {
                console.error('Failed to load saved APIs:', err);
                listContainer.innerHTML = '<div class="text-sm text-red-400 text-center py-4">Failed to load</div>';
            }
        }

        function fillApiForm(element) {
            if (isLongPress) return;
            const id = element.getAttribute('data-id');
            const responseBody = document.getElementById('responseBody');
            const searchInput = document.getElementById('exampleSearch');
            const dropdown = document.getElementById('exampleDropdown');
            if (selectedApiId === id) {
                selectedApiId = null;
                element.classList.remove('ring-2','ring-blue-400','bg-blue-50','border-blue-400');
                document.getElementById('moduleName').value = '';
                document.getElementById('methodName').value = '';
                document.getElementById('requestMethod').value = '';
                document.getElementById('parameters').value = '';
                responseBody.textContent = '';
                if (searchInput) searchInput.value = '';
                if (dropdown) dropdown.classList.add('hidden');
                return;
            }
            selectedApiId = id;
            document.querySelectorAll('#savedApisList .api-item').forEach(el => {
                el.classList.remove('ring-2','ring-blue-400','bg-blue-50','border-blue-400');
            });
            element.classList.add('ring-2','ring-blue-400','bg-blue-50','border-blue-400');
            if (searchInput) searchInput.value = '';
            if (dropdown) dropdown.classList.add('hidden');
            try {
                const item = JSON.parse(element.getAttribute('data-item'));
                document.getElementById('moduleName').value = item.module_name || '';
                document.getElementById('methodName').value = item.method_name || '';
                document.getElementById('requestMethod').value = item.request_method || '';
                if (item.params) {
                    document.getElementById('parameters').value = JSON.stringify(item.params, null, 4);
                } else {
                    document.getElementById('parameters').value = '';
                }
                
                if (item.response) {
                    if (typeof item.response === 'object') {
                        responseBody.textContent = JSON.stringify(item.response, null, 2);
                    } else {
                        responseBody.textContent = item.response;
                    }
                } else {
                    responseBody.textContent = '';
                }
            } catch (e) {
                console.error("Error filling form:", e);
            }
        }

        // Long press handling
        let pressTimer;
        let isLongPress = false;
        let selectedApiId = null;

        function handleApiItemPress(element, id) {
            isLongPress = false;
            pressTimer = setTimeout(() => {
                isLongPress = true;
                if (confirm('Delete this saved API?')) {
                    deleteSavedApi(id);
                }
            }, 800); // 800ms for long press
        }

        function cancelApiItemPress() {
            clearTimeout(pressTimer);
        }

        async function deleteSavedApi(id) {
            try {
                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        module_name: 'services.database.data_service',
                        method_name: 'delete_document',
                        parameters: { 
                            cname: 'apis', 
                            id: id 
                        }
                    })
                };
                
                const res = await fetch('/', options);
                if (res.status === 200) {
                    loadSavedApis(); // Refresh list
                } else {
                    alert('Failed to delete API');
                }
            } catch (e) {
                console.error("Delete error:", e);
                alert('Error deleting API');
            }
        }

        async function sendRequest() {
            const moduleName = document.getElementById('moduleName').value;
            const methodName = document.getElementById('methodName').value;
            const method = document.getElementById('requestMethod').value;
            let paramsStr = document.getElementById('parameters').value;

            // Validate JSON
            try {
                if (paramsStr.trim()) {
                    JSON.parse(paramsStr);
                } else {
                    paramsStr = "{}";
                }
            } catch (e) {
                alert("Invalid JSON parameters");
                return;
            }

            const loading = document.getElementById('loading');
            const responseBody = document.getElementById('responseBody');
            const statusBadge = document.getElementById('statusBadge');

            loading.classList.remove('hidden');
            responseBody.textContent = '';
            statusBadge.classList.add('hidden');

            try {
                let url = '/';
                let options = {
                    method: method,
                    headers: {}
                };

                if (method === 'GET') {
                    const queryParams = new URLSearchParams({
                        module_name: moduleName,
                        method_name: methodName,
                        parameters: paramsStr
                    });
                    url += `?${queryParams.toString()}`;
                } else {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify({
                        module_name: moduleName,
                        method_name: methodName,
                        parameters: JSON.parse(paramsStr)
                    });
                }

                const startTime = performance.now();
                const res = await fetch(url, options);
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(0);

                const status = res.status;
                let data;
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    data = await res.json();
                } else {
                    data = await res.text();
                }

                // Update UI
                statusBadge.textContent = `${status} (${duration}ms)`;
                statusBadge.className = `px-2 py-1 text-xs font-bold rounded ${status >= 200 && status < 300 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                statusBadge.classList.remove('hidden');

                if (typeof data === 'object') {
                    responseBody.textContent = JSON.stringify(data, null, 2);
                } else {
                    responseBody.textContent = data;
                }

            } catch (err) {
                responseBody.textContent = `Error: ${err.message}`;
                statusBadge.textContent = 'Error';
                statusBadge.className = 'px-2 py-1 text-xs font-bold rounded bg-red-100 text-red-800';
                statusBadge.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function saveApiData(btn) {
            const moduleName = document.getElementById('moduleName').value;
            const methodName = document.getElementById('methodName').value;
            const requestMethod = document.getElementById('requestMethod').value;
            const paramsStr = document.getElementById('parameters').value;
            const responseText = document.getElementById('responseBody').textContent;

            let params;
            try {
                if (paramsStr.trim()) {
                    params = JSON.parse(paramsStr);
                } else {
                    params = {};
                }
            } catch (e) {
                alert("Invalid JSON parameters");
                return;
            }

            let response;
            try {
                if (responseText && responseText.trim()) {
                    response = JSON.parse(responseText);
                } else {
                    response = responseText;
                }
            } catch (e) {
                response = responseText;
            }

            const docData = {
                cname: 'apis',
                module_name: moduleName,
                method_name: methodName,
                request_method: requestMethod,
                params: params,
                response: response
            };

            const loading = document.getElementById('loading');
            const statusBadge = document.getElementById('statusBadge');

            loading.classList.remove('hidden');

            try {
                const isEdit = !!selectedApiId;
                const payload = isEdit ? {
                    module_name: 'services.database.data_service',
                    method_name: 'update_document',
                    parameters: {
                        cname: 'apis',
                        data: {
                            key: selectedApiId,
                            module_name: moduleName,
                            method_name: methodName,
                            request_method: requestMethod,
                            params: params,
                            response: response
                        }
                    }
                } : {
                    module_name: 'services.database.data_service',
                    method_name: 'create_document',
                    parameters: docData
                };

                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                };

                const res = await fetch('/', options);
                const status = res.status;
                
                if (status === 200) {
                    const originalText = btn.innerText;
                    const originalClasses = btn.className;
                    btn.innerText = isEdit ? "Updated!" : "Saved!";
                    btn.className = "px-4 py-2 bg-green-700 text-white rounded transition";
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.className = originalClasses;
                    }, 1000);
                    
                    // Refresh the list
                    loadSavedApis();
                } else {
                    alert('Failed to save API');
                }

            } catch (err) {
                console.error("Save error:", err);
                alert('Error saving API');
            } finally {
                loading.classList.add('hidden');
            }
        }


    </script>
</body>
</html>
