.chatPage{
  /* 兜底：部分浏览器不支持 100dvh，会导致高度计算失效，从而把底部输入框“挤出屏幕” */
  height: calc(100vh - 56px - var(--safe-top));
  height: calc(100dvh - 56px - var(--safe-top));
  display:flex;
  flex-direction:column;
  background:#ededed;
}
.chatPage[hidden]{display:none !important}
.chatPage__messages{
  flex:1;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  /* 为底部输入框预留空间，避免最后几条消息被盖住（两行布局需要更多空间） */
  padding: 4px 6px calc(120px + var(--safe-bottom));
  overscroll-behavior: contain;
  /* 降低滚动时的重绘影响（尤其长对话） */
  contain: paint layout style;
  /* 启用硬件加速，优化滚动性能 - 使用更强的硬件加速 */
  transform: translate3d(0, 0, 0);
  -webkit-transform: translate3d(0, 0, 0);
  will-change: scroll-position;
  /* 优化滚动性能 */
  scroll-behavior: auto;
  /* 减少滚动时的重绘 */
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  /* 优化合成层性能 */
  isolation: isolate;
}

/* 确保聊天页的输入框固定在屏幕底部且不会被遮挡 */
.chatComposer{
  position:fixed;
  left:0;
  right:0;
  bottom: var(--vv-bottom);
  z-index:55;
}

.chatMsg{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin: 4px 0;
  /* 长列表滚动性能：对支持 content-visibility 的浏览器提升明显；不支持的会忽略 */
  content-visibility: auto;
  contain: content layout style;
  contain-intrinsic-size: 120px;
  /* 优化渲染性能 - 使用硬件加速 */
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
  /* 减少重绘 */
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}
.chatMsg--bot{ --chat-bubble-bg:#fff; }
.chatMsg--me{ --chat-bubble-bg:#95ec69; }

.chatMsgContentRow{
  display:flex;
  gap:6px;
  align-items:flex-end;
}
.chatMsg--me .chatMsgContentRow{
  justify-content:flex-end;
}
.chatAvatar{
  width:30px;height:30px;border-radius:7px;
  background: rgba(0,0,0,.08);
  flex:none;
  display:grid;place-items:center;
  font-weight:800;
  color:#555;
}
.chatMsg--me .chatAvatar{
  background: rgba(7,193,96,.22);
  color:#056a36;
}
.chatBubble{
  max-width: 92%;
  padding: 5px 7px;
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.42;
  word-break: break-word;
  white-space: pre-wrap;
  box-shadow: 0 1px 0 rgba(0,0,0,.04);
}

.chatBubbleWrap{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:0;
  position: relative;
  width:100%;
}
.chatMsg--bot .chatBubbleWrap{align-items:flex-start}
.chatMsg--me .chatBubbleWrap{align-items:flex-end}

/* 消息时间和操作按钮容器（时间在第一行，按钮在第二行） */
.chatMsgTimeActions{
  display:flex;
  flex-direction:row;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-top:0;
  max-width:92%;
  width:100%;
  opacity:1;
  transition:opacity 0.2s ease;
  box-sizing:border-box;
}
.chatMsg--bot .chatMsgTimeActions{
  margin-left:36px;
  align-items:flex-start;
}
.chatMsg--me .chatMsgTimeActions{
  margin-left:auto;
  margin-right:0;
  align-items:flex-end;
}

/* 消息时间样式 */
.chatMsgTime{
  font-size:11px;
  color:#999;
  min-width:0;
}
.chatMsg--me .chatMsgTime{
  text-align:right;
}
.chatMsg--bot .chatMsgTime{
  text-align:left;
}

/* 消息操作按钮容器 */
.chatMsgActions{
  display:flex;
  align-items:center;
  gap:4px;
  flex-shrink:0;
}

/* 复制按钮样式 */
.chatMsgActionBtn{
  width:28px;
  height:28px;
  border-radius:50%;
  background:rgba(0,0,0,.08);
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:14px;
  transition:all 0.2s ease;
  opacity:0.7;
  flex-shrink:0;
}
.chatMsgActionBtn svg{
  width:16px;
  height:16px;
  fill:currentColor;
}
.chatMsgActionBtn:hover{
  background:rgba(0,0,0,.12);
  transform:scale(1.1);
  opacity:1;
}
.chatMsgActionBtn:active{
  transform:scale(0.95);
}
.chatMsgActionBtn:disabled{
  opacity:0.3;
  cursor:not-allowed;
  pointer-events:none;
}

/* 排序按钮样式 */
.chatMsgActionBtn--sort{
  font-size:12px;
}

/* 纸飞机按钮样式（发送 prompt 接口，参考 YiPet 项目） */
.chatMsgActionBtn--prompt{
  font-size:16px;
  font-weight:500;
  color:#07c160;
  background:white;
  border:1px solid #07c160;
  transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  width:28px;
  height:28px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.chatMsgActionBtn--prompt:hover{
  background:#07c160;
  color:white;
  border-color:#07c160;
  transform:scale(1.1);
  opacity:1;
}
.chatMsgActionBtn--prompt:active{
  transform:scale(0.95);
}
.chatMsgActionBtn--prompt:disabled{
  opacity:0.5;
  cursor:not-allowed;
  pointer-events:none;
}

/* 删除按钮样式 */
.chatMsgActionBtn--delete{
  font-size:16px;
  font-weight:500;
  color:var(--danger);
  background:white;
  border:1px solid var(--danger);
  transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  width:28px;
  height:28px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.chatMsgActionBtn--delete:hover{
  background:var(--danger);
  color:white;
  border-color:var(--danger);
  transform:scale(1.1);
  opacity:1;
}
.chatMsgActionBtn--delete:active{
  transform:scale(0.95);
}
.chatMsgActionBtn--delete:disabled{
  opacity:0.5;
  cursor:not-allowed;
  pointer-events:none;
}

.chatMsgActionBtn.is-copied{
  color:#4caf50;
}
.chatMsgActionBtn.is-busy{
  opacity:0.5;
}

/* Markdown/代码块基础样式（服务 Mermaid 代码块展示） */
.chatBubble--md{
  /* marked 输出为 HTML（p/ul/pre...），这里不要用 pre-wrap，避免默认段落间距叠加导致“空一大块” */
  white-space: normal;
  font-size: 13px;
  line-height: 1.48;
}

/* 欢迎消息样式 */
[data-welcome-message] {
  margin-bottom: 20px;
}

[data-welcome-message] .chatBubble {
  padding: 8px 10px 0;
  line-height: 1.6;
  overflow: visible;
  max-height: none;
}

[data-welcome-message] .chatBubble > div {
  margin: 0;
  overflow: visible;
}

[data-welcome-message] .welcomeMessage{
  margin-bottom:10px;
  padding:16px;
  background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(68, 160, 141, 0.05));
  border-radius:12px;
  border-left:3px solid #4ECDC4;
}
[data-welcome-message] .welcomeSection{
  margin-bottom:12px;
}
[data-welcome-message] .welcomeLabel{
  font-size:12px;
  color:#6B7280;
  margin-bottom:4px;
  font-weight:500;
}
[data-welcome-message] .welcomeLink{
  word-break: break-all;
  color:#2196F3;
  text-decoration:none;
  font-size:13px;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient: vertical;
  overflow:hidden;
  max-width:100%;
  line-height:1.6;
  text-overflow:ellipsis;
}
[data-welcome-message] .welcomeLink:hover{
  text-decoration:underline;
}
[data-welcome-message] .welcomeDesc{
  font-size:13px;
  color:#666;
  border-radius:7px;
  padding:8px 12px;
  line-height:1.7;
  padding-left:0.5em;
}

[data-welcome-message] a {
  transition: all 0.2s ease;
}

/* 统一 Markdown 的块级元素间距：更紧凑、更接近聊天气泡的阅读节奏 */
.chatBubble--md p,
.chatBubble--md ul,
.chatBubble--md ol,
.chatBubble--md blockquote,
.chatBubble--md pre,
.chatBubble--md table,
.chatBubble--md hr{
  margin: 0 0 6px;
}
.chatBubble--md h1,
.chatBubble--md h2,
.chatBubble--md h3,
.chatBubble--md h4,
.chatBubble--md h5,
.chatBubble--md h6{
  margin: 8px 0 6px;
  line-height: 1.25;
  font-weight: 800;
}
.chatBubble--md > :first-child{ margin-top: 0; }
.chatBubble--md > :last-child{ margin-bottom: 0; }

.chatBubble--md ul,
.chatBubble--md ol{
  padding-left: 16px;
}
.chatBubble--md li{ margin: 2px 0; }
.chatBubble--md li > p{ margin: 0; }

.chatBubble--md blockquote{
  padding: 6px 10px;
  border-left: 3px solid rgba(0,0,0,.18);
  background: rgba(0,0,0,.04);
  border-radius: 10px;
}
.chatBubble--md hr{
  border: 0;
  border-top: 1px solid rgba(0,0,0,.12);
}
.chatBubble--md a{
  color: inherit;
  text-decoration: underline;
  text-underline-offset: 2px;
}
.chatBubble--md img{
  max-width: 100%;
  height: auto;
  display: block;
  border-radius: 10px;
  margin: 4px 0;
  cursor: zoom-in;
}

.chatImage{
  max-width:200px;
  margin-bottom:6px;
}
.chatImage__img{
  max-width:100%;
  height:auto;
  border-radius:4px;
  display:block;
}

.chatBubble--md pre{
  margin: 6px 0;
  padding: 8px 10px;
  background: rgba(0,0,0,.06);
  border-radius: 10px;
  overflow-x: auto;
}
.chatBubble--md code{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 13px;
}
.chatBubble--md :not(pre) > code{
  padding: 1px 6px;
  border-radius: 8px;
  background: rgba(0,0,0,.06);
}

/* Mermaid 渲染结果 */
.chatBubble--md .mermaid{
  background: #fff;
  border-radius: 12px;
  padding: 8px;
  overflow-x: auto;
}
.chatBubble--md .mermaid svg{
  max-width: 100%;
  height: auto;
  display: block;
}
.chatMsg--bot .chatBubble{
  background:var(--chat-bubble-bg);
  border-top-left-radius: 6px;
}
.chatMsg--me .chatBubble{
  background:var(--chat-bubble-bg);
  border-top-right-radius: 6px;
}

.chatComposer{
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:
    10px
    calc(10px + var(--safe-right))
    calc(10px + var(--safe-bottom))
    calc(10px + var(--safe-left));
  background: rgba(247,247,247,.98);
  border-top: 1px solid var(--divider);
}
.chatComposer__topRow{
  display:flex;
  gap:10px;
  width:100%;
}
.chatComposer__bottomRow{
  display:flex;
  gap:10px;
  width:100%;
  align-items:center;
}
.chatComposer__btn--faq,
.chatComposer__btn--context,
.chatComposer__btn--url{
  min-width:64px;
  height:40px;
  border-radius:999px;
  background:#fff;
  border: 1px solid rgba(0,0,0,.10);
  color:#2a2a2a;
  flex:1 1 0;
  padding:0 16px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  white-space:nowrap;
}
.chatComposer__topRow .chatComposer__btn--context{
  min-width:80px;
  padding:0 20px;
}
.chatComposer__btn--faq:active,
.chatComposer__btn--context:active,
.chatComposer__btn--url:active{
  opacity:.85;
}
.chatComposer__btnLabel{
  font-size:12px;
  font-weight:600;
  line-height:1;
}
.chatComposer__btn--faq svg,
.chatComposer__btn--context svg,
.chatComposer__btn--url svg{
  width:18px;
  height:18px;
  flex:none;
}
.chatComposer__input{
  flex:1;
  height: 40px;
  padding: 0 12px;
  border-radius: 10px;
  background:#fff;
  border: 1px solid rgba(0,0,0,.10);
  font-size: 16px;
}
.chatComposer__btn{
  height:40px;
  border-radius:10px;
  padding: 0 12px;
  font-weight:800;
  font-size:14px;
}
.chatComposer__btn--send{
  background: var(--green);
  color:#fff;
}
.chatComposer__btn:active{opacity:.85}

@media (hover: hover) and (min-width: 900px){
  .chatComposer{
    backdrop-filter: saturate(140%) blur(16px);
  }
}
